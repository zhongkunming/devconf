pipeline {
    agent any

    options {
        timeout(time: 10, unit: 'MINUTES')
        disableConcurrentBuilds()
        timestamps()
    }

    tools {
        jdk 'jdk21'
        maven 'maven3.9'
    }

    stages {
        stage('pull source code') {
            steps {
                echo "ğŸš€ å¼€å§‹æ‹‰å–æºç ..."
                git branch: 'main',
                    url: 'http://192.168.10.10:30180/zhongkunming/supervisor.git',
                    credentialsId: 'jenkins-git'
            }
        }

        stage('build jar') {
            steps {
                script {
                    echo "ğŸ“¦ å¼€å§‹æ„å»º Jar åŒ…..."
                    sh 'java -version'
                    sh 'mvn -v'
                    sh 'mvn -DskipTests=true clean package'
                }
            }
        }

        stage('fetch script') {
            steps {
                script {
                    echo "ğŸ“ ä¸‹è½½å¯åŠ¨è„šæœ¬..."
                    sh 'curl http://192.168.10.10:30180/zhongkunming/devshell/raw/branch/main/supervisor/supervisorctl.sh -o supervisorctl.sh'
                }
            }
        }

        stage('deploy') {
            steps {
                script {
                    echo "ğŸ“¡ æ­£åœ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨..."
                    sshPublisher(
                        publishers: [
                            sshPublisherDesc(
                                configName: 'deploy-supervisor',
                                transfers: [
                                    sshTransfer(
                                        sourceFiles: 'target/supervisor.jar',
                                        removePrefix: 'target'
                                    ),
                                    sshTransfer(
                                        sourceFiles: 'supervisorctl.sh',
                                        remoteDirectory: '/sbin',
                                        execCommand:
                                            '''chmod +x ./sbin/supervisorctl.sh
                                            ./sbin/supervisorctl.sh start'''
                                    )
                                ],
                                verbose: true
                            )
                        ]
                    )
                }
            }
        }
    }

    post {
        always {
            cleanWs()
            echo "ğŸ§¹ æ¸…ç†å·¥ä½œåŒºå®Œæˆ"
        }
        success {
            echo "âœ… æ„å»ºä¸éƒ¨ç½²æˆåŠŸï¼"
        }
        failure {
            echo "âŒ æ„å»ºæˆ–éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
        }
    }
}
